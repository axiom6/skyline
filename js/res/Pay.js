// Generated by CoffeeScript 1.12.2
(function() {
  var $, Pay,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    hasProp = {}.hasOwnProperty;

  $ = require('jquery');

  Pay = (function() {
    module.exports = Pay;

    function Pay(stream, store, room1, cust, res, home, Data) {
      this.stream = stream;
      this.store = store;
      this.room = room1;
      this.cust = cust;
      this.res = res;
      this.home = home;
      this.Data = Data;
      this.onError = bind(this.onError, this);
      this.onCharge = bind(this.onCharge, this);
      this.onToken = bind(this.onToken, this);
      this.submitPayment = bind(this.submitPayment, this);
      this.initCCPayment = bind(this.initCCPayment, this);
      this.onMakePayment = bind(this.onMakePayment, this);
      this.onMakeDeposit = bind(this.onMakeDeposit, this);
      this.onChangeReser = bind(this.onChangeReser, this);
      this.showConfirmPay = bind(this.showConfirmPay, this);
      this.uri = "https://api.stripe.com/v1/";
      this.subscribe();
      $.ajaxSetup({
        headers: {
          "Authorization": this.Data.stripeCurlKey
        }
      });
      this.myRes = {};
      this.created = false;
      this.first = '';
      this.last = '';
      this.phone = '';
      this.email = '';
      this.spas = false;
      this.purpose = 'PayInFull';
      this.testing = true;
      this.errored = false;
    }

    Pay.prototype.showSpa = function(myRes) {
      var ref, room, roomId;
      ref = myRes.rooms;
      for (roomId in ref) {
        if (!hasProp.call(ref, roomId)) continue;
        room = ref[roomId];
        if (this.room.hasSpa(roomId)) {
          return true;
        }
      }
      return false;
    };

    Pay.prototype.showConfirmPay = function(myRes) {
      this.myRes = myRes;
      this.myRes['cust'] = this.cust.createCust(this.first, this.last, this.phone, this.email, 'site');
      if (this.created) {
        $('#ConfirmTitle').remove();
        $('#ConfirmTable').remove();
        $('#Confirm').prepend(this.confirmHtml(this.myRes));
        $('#cc-amt').text('$' + this.myRes.total);
        $('#form-pay').show();
        $('#Pays').show();
      } else {
        $('#Pays').append(this.confirmHtml(this.myRes));
        $('#Pays').append(this.payHtml());
        $('#Pays').show();
        window.$ = $;
        Util.loadScript("../js/res/payment.js", this.initCCPayment);
        $('#cc-amt').text('$' + this.myRes.total);
        $('#ChangeReser').click((function(_this) {
          return function(e) {
            return _this.onChangeReser(e);
          };
        })(this));
        $('#MakeDeposit').click((function(_this) {
          return function(e) {
            return _this.onMakeDeposit(e);
          };
        })(this));
        $('#MakePayment').click((function(_this) {
          return function(e) {
            return _this.onMakePayment(e);
          };
        })(this));
        $('.SpaCheck').change((function(_this) {
          return function(e) {
            return _this.onSpa(e);
          };
        })(this));
        this.created = true;
      }
      if (this.testing) {
        this.testPop();
      }
    };

    Pay.prototype.testPop = function() {
      $('#cc-num').val('4242424242424242');
      $('#cc-exp').val('10 / 19');
      return $('#cc-cvc').val('555');
    };

    Pay.prototype.onChangeReser = function(e) {
      e.preventDefault();
      $('#Make').text('Change Reservation');
      $('#Pays').hide();
      $('#Book').show();
    };

    Pay.prototype.onMakeDeposit = function(e) {
      e.preventDefault();
      this.purpose = 'Deposit';
      $("#cc-amt").text('$' + this.myRes.deposit);
      return $('#MakePay').text('Make 50% Deposit');
    };

    Pay.prototype.onMakePayment = function(e) {
      e.preventDefault();
      this.purpose = 'PayInFull';
      $("#cc-amt").text('$' + this.myRes.total);
      return $('#MakePay').text('Make Payment');
    };

    Pay.prototype.confirmHtml = function(myRes) {
      var arrive, days, depart, htm, num, r, ref, roomId, spaTH;
      this.spas = this.showSpa(this.myRes);
      spaTH = this.spas ? "Spa" : "";
      htm = "<div   id=\"ConfirmTitle\" class= \"Title\">Confirmation # " + myRes.key + "</div>";
      htm += "<div   id=\"ConfirmName\">\n   <span>For: " + this.first + " </span><span>" + this.last + " </span>\n</div>";
      htm += "<div class=\"DivCenter\"><table id=\"ConfirmTable\"><thead>";
      htm += "<tr><th>Cottage</th><th>Guests</th><th>Pets</th><th>" + spaTH + "</th><th>Price</th><th class=\"arrive\">Arrive</th><th class=\"depart\">Depart</th><th>Nights</th><th>Total</th></tr>";
      htm += "</thead><tbody>";
      ref = myRes.rooms;
      for (roomId in ref) {
        if (!hasProp.call(ref, roomId)) continue;
        r = ref[roomId];
        days = Object.keys(r.days).sort();
        num = days.length;
        arrive = this.confirmDate(days[0], "", false);
        depart = this.confirmDate(days[num - 1], "", true);
        htm += "<tr><td class=\"td-left\">" + r.name + "</td><td class=\"guests\">" + r.guests + "</td><td class=\"pets\">" + r.pets + "</td><td>" + (this.spa(roomId)) + "</td><td class=\"room-price\">$" + r.price + "</td><td>" + arrive + "</td><td>" + depart + "</td><td class=\"nights\">" + num + "</td><td class=\"room-total\">$" + r.total + "</td></tr>";
      }
      htm += "<tr><td></td><td></td><td></td><td></td><td></td><td class=\"arrive-times\">Arrival is from 3:00-8:00PM</td><td class=\"depart-times\">Checkout is before 10:00AM</td><td></td><td class=\"room-total\">$" + myRes.total + "</td></tr>";
      htm += "</tbody></table></div>";
      htm += "<div class=\"PayBtns\">";
      htm += "  <button class=\"btn btn-primary\" id=\"ChangeReser\">Change Reservation</button>";
      if (this.canMakeDeposit(this.myRes)) {
        htm += "  <button class=\"btn btn-primary\" id=\"MakeDeposit\">Make 50% Deposit</button>";
      }
      htm += "  <button class=\"btn btn-primary\" id=\"MakePayment\">Make Payment</button>";
      htm += "</div>";
      htm += "<div id=\"MakePay\" class=\"Title\">Make Payment</div>";
      return htm;
    };

    Pay.prototype.canMakeDeposit = function(myRes) {
      return this.myRes.arrive >= this.Data.advanceDate(this.myRes.booked, 7);
    };

    Pay.prototype.spa = function(roomId) {
      Util.log("Util.spa()", roomId, this.room.hasSpa(roomId));
      if (this.room.hasSpa(roomId)) {
        return "<input id=\"" + roomId + "SpaCheck\" class=\"SpaCheck\" type=\"checkbox\" value=\"" + roomId + "\" checked>";
      } else {
        return "";
      }
    };

    Pay.prototype.onSpa = function(event) {
      var $elem, checked, roomId, spaFee;
      $elem = $(event.target);
      roomId = $elem.attr('id').charAt(0);
      checked = $elem.is(':checked');
      spaFee = checked ? 20 : -20;
      this.myRes.rooms[roomId].total += spaFee;
    };

    Pay.prototype.confirmBody = function() {
      var arrive, body, days, depart, num, r, ref, room, roomId;
      body = ".      Confirmation# " + this.myRes.key + "\n";
      body += ".      For: " + this.first + " " + this.last + "\n";
      ref = this.myRes.rooms;
      for (roomId in ref) {
        if (!hasProp.call(ref, roomId)) continue;
        r = ref[roomId];
        room = Util.padEnd(r.name, 24, '-');
        days = Object.keys(r.days).sort();
        num = days.length;
        arrive = this.confirmDate(days[0], "", false);
        depart = this.confirmDate(days[num - 1], "", true);
        body += room + " $" + r.price + "  " + r.guests + "-Guests " + r.pets + "-Pets Arrive:" + arrive + " Depart:" + depart + " " + num + "-Nights $" + r.total + "\n";
      }
      body += "\n.      Arrival is from 3:00-8:00PM   Checkout is before 10:00AM\n";
      body = escape(body);
      return body;
    };

    Pay.prototype.confirmEmail = function() {
      var win;
      win = window.open("mailto:" + this.email + "?subject=Skyline Cottages Confirmation&body=" + (this.confirmBody()), "EMail");
      if ((win != null) && !win.closed) {
        win.close();
      }
    };

    Pay.prototype.departDate = function(monthI, dayI, weekdayI) {
      var dayO, monthO, weekdayO;
      dayO = dayI + 1;
      monthO = monthI;
      weekdayO = (weekdayI + 1) % 7;
      if (dayI >= this.Data.numDayMonth[monthI]) {
        dayO = 1;
        monthO = monthI + 1;
      }
      return [monthO, dayO, weekdayO];
    };

    Pay.prototype.confirmDate = function(dayStr, msg, isDepart) {
      var day, monthIdx, ref, weekdayIdx, year;
      year = parseInt(dayStr.substr(0, 4));
      monthIdx = parseInt(dayStr.substr(4, 2)) - 1;
      day = parseInt(dayStr.substr(6, 2));
      weekdayIdx = new Date(year, monthIdx, day).getDay();
      if (isDepart) {
        ref = this.departDate(monthIdx, day, weekdayIdx), monthIdx = ref[0], day = ref[1], weekdayIdx = ref[2];
      }
      return this.Data.weekdays[weekdayIdx] + " " + this.Data.months[monthIdx] + " " + day + ", " + year + "  " + msg;
    };

    Pay.prototype.payHtml = function() {
      return "<div id=\"PayDiv\">\n  <form novalidate autocomplete=\"on\" method=\"POST\" id=\"form-pay\">\n\n    <span class=\"form-group\">\n      <label for=\"cc-num\" class=\"control-label\">Card Number<span class=\"text-muted\">  [<span class=\"cc-com\"></span>]</span></label>\n      <input id= \"cc-num\" type=\"tel\" class=\"input-lg form-control cc-num\" autocomplete=\"cc-num\" placeholder=\"•••• •••• •••• ••••\" required>\n      <div   id= \"er-num\" class=\"cc-msg\"></div>\n    </span>\n\n    <span class=\"form-group\">\n      <label for=\"cc-exp\" class=\"control-label\">Expiration</label>\n      <input id= \"cc-exp\" type=\"tel\" class=\"input-lg form-control cc-exp\" autocomplete=\"cc-exp\" placeholder=\"mm / yy\" required>\n      <div   id= \"er-exp\" class=\"cc-msg\"></div>\n    </span>\n\n    <span class=\"form-group\">\n      <label for=\"cc-cvc\" class=\"control-label\">CVC</label>\n      <input id= \"cc-cvc\" type=\"tel\" class=\"input-lg form-control cc-cvc\" autocomplete=\"off\" placeholder=\"•••\" required>\n      <div   id= \"er-cvc\" class=\"cc-msg\"></div>\n    </span>\n\n    <span class=\"form-group\">\n      <label for=\"cc-amt\"   class=\"control-label\">Amount</label>\n      <div   id= \"cc-amt\" class=\"input-lg form-control cc-amt\"></div>\n      <div   id= \"er-amt\" class=\"cc-msg\"></div>\n    </span>\n\n    <span class=\"form-group\">\n      <label  for=\"cc-sub\" class=\"control-label\">&nbsp;</label>\n      <button  id=\"cc-sub\" type=\"submit\" class=\"btn btn-lg btn-primary\">Pay</button>\n      <div    id= \"er-sub\" class=\"cc-msg\"></div>\n    </span>\n  </form>\n</div>\n<div id=\"Approval\"></div>";
    };

    Pay.prototype.toggleInputError = function(field, valid) {
      var msg;
      msg = '';
      if (!valid) {
        msg = (function() {
          switch (field) {
            case 'Num':
              return "Card Number?";
            case 'Exp':
              return "Expiration?";
            case 'CVC':
              return "CVC?";
          }
        })();
      }
      return msg;
    };

    Pay.prototype.initCCPayment = function() {
      $('.cc-num').payment('formatCardNumber');
      $('.cc-exp').payment('formatCardExpiry');
      $('.cc-cvc').payment('formatCardCVC');
      return $('form').submit((function(_this) {
        return function(e) {
          return _this.submitPayment(e);
        };
      })(this));
    };

    Pay.prototype.submitPayment = function(e) {
      var cardType, cvc, cvcerr, exp, experr, mon, num, numerr, ref, yer;
      e.preventDefault();
      num = $('.cc-num').val();
      exp = $('.cc-exp').val();
      mon = exp.substr(0, 2);
      yer = '20' + exp.substr(5, 2);
      cvc = $('.cc-cvc').val();
      cardType = $.payment.cardType(num);
      numerr = this.toggleInputError('Num', $.payment.validateCardNumber($('.cc-num').val()));
      experr = this.toggleInputError('Exp', $.payment.validateCardExpiry($('.cc-exp').payment('cardExpiryVal')));
      cvcerr = this.toggleInputError('CVC', $.payment.validateCardCVC($('.cc-cvc').val(), cardType));
      $('.cc-com').text(cardType);
      $('.cc-msg').removeClass('text-danger text-success');
      $('.cc-msg').addClass((ref = $('.has-error').length) != null ? ref : {
        'text-danger': 'text-success'
      });
      if (numerr === '' && experr === '' && cvcerr === '') {
        $('#er-sub').text("Waiting For Approval");
        this.token(num, mon, yer, cvc);
        this.last4 = num.substr(11, 4);
      } else {
        $('#er-num').text(numerr);
        $('#er-exp').text(experr);
        $('#er-cvc').text(cvcerr);
        $('#er-sub').text("Fix?");
        $('#cc-sub').text("Try Again");
      }
      Util.log('Pay.submitPayment()', {
        num: num,
        exp: exp,
        cvc: cvc,
        mon: mon,
        yer: yer
      });
    };

    Pay.prototype.subscribe = function() {
      this.stream.subscribe('tokens', this.onToken, this.onError);
      return this.stream.subscribe('charges', this.onCharge, this.onError);
    };

    Pay.prototype.token = function(number, exp_month, exp_year, cvc) {
      var input;
      input = {
        "card[number]": number,
        "card[exp_month]": exp_month,
        "card[exp_year]": exp_year,
        "card[cvc]": cvc
      };
      this.ajaxRest("tokens", 'post', input);
    };

    Pay.prototype.charge = function(token, amount, currency, description) {
      var input;
      input = {
        source: token,
        amount: amount,
        currency: currency,
        description: description
      };
      this.ajaxRest("charges", 'post', input);
    };

    Pay.prototype.onToken = function(obj) {
      Util.log('StoreRest.onToken()', obj);
      this.tokenId = obj.id;
      this.cardId = obj.card.id;
      return this.charge(this.tokenId, this.myRes.total, 'usd', 'First Test Charge');
    };

    Pay.prototype.onCharge = function(obj) {
      Util.log('StoreRest.onCharge()', obj);
      if (obj.outcome.type === 'authorized') {
        this.confirmEmail();
        $('#cc-bak').hide();
        $('#MakePay').hide();
        $('#PayDiv').hide();
        $('#Approval').text("Approved: A Confirnation Email Been Sent To " + this.email).show();
        this.home.showConfirm();
        this.myRes.payments[this.payId()] = this.createPayment();
        return this.store.put('Res', this.myRes.key, this.myRes);
      } else {
        return $('#Approval').text('Denied').show();
      }
    };

    Pay.prototype.payId = function() {
      var pays;
      pays = Object.keys(this.myRes.payments).sort();
      if (pays.length > 0) {
        return toString(parseInt(pays[pays.length - 1]) + 1);
      } else {
        return '1';
      }
    };

    Pay.prototype.createPayment = function() {
      var payment;
      payment = {};
      payment.amount = this.myRes.total;
      payment.date = this.Data.today();
      payment.method = 'card';
      payment["with"] = this.last4;
      payment.purpose = this.purpose;
      return payment;
    };

    Pay.prototype.onError = function(obj) {
      return Util.error('StoreRest.onError()', obj);
    };

    Pay.prototype.ajaxRest = function(table, op, input) {
      var settings, url;
      url = this.uri + table;
      settings = {
        url: url,
        type: op
      };
      settings.headers = {
        Authorization: 'Bearer ' + this.Data.stripeTestKey
      };
      settings.data = input;
      settings.success = (function(_this) {
        return function(result, status, jqXHR) {
          _this.stream.publish(table, result);
          return Util.noop(jqXHR, status);
        };
      })(this);
      settings.error = (function(_this) {
        return function(jqXHR, status, error) {
          Util.error('StoreRest.ajaxRest()', {
            status: status,
            error: error
          });
          return Util.noop(jqXHR);
        };
      })(this);
      $.ajax(settings);
    };

    Pay.prototype.toQuery = function(input) {
      var key, query, val;
      query = "";
      if (input == null) {
        return query;
      }
      for (key in input) {
        if (!hasProp.call(input, key)) continue;
        val = input[key];
        query += "@" + key + "=" + val;
      }
      return query[0] = '?';
    };

    Pay.prototype.toJSON = function(obj) {
      if (obj != null) {
        return JSON.stringify(obj);
      } else {
        return '';
      }
    };

    Pay.prototype.toObject = function(json) {
      if (json) {
        return JSON.parse(json);
      } else {
        return {};
      }
    };

    return Pay;

  })();

}).call(this);
